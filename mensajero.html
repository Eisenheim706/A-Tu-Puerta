<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Mensajeros - A TU PUERTA</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script src="https://unpkg.com/@mapbox/polyline@1.1.1"></script>
  <style>
    :root {
      --primary: #2196f3;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --dark: #333;
      --light: #f5f5f5;
      --sombra: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    body {
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    header {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.9), rgba(13, 139, 242, 0.9)), 
                  url('img/icono_logo.png') center/contain no-repeat;
      color: white;
      padding: 20px 0;
      text-align: center;
      position: relative;
      height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: var(--sombra);
    }
    
    header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
    }
    
    header .contenedor {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
      z-index: 2;
    }
    
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    header p {
      font-size: 1.2rem;
      opacity: 0.9;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    
    .contenedor {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      width: 80%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    .pedido-info-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Botones */
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn {
      flex: 1;
      min-width: 150px;
      padding: 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    
    /* Botón flotante para ubicación manual */
    .btn-flotante {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* Modal para tipo de ubicación */
    .modal-tipo-ubicacion .modal-content {
      max-width: 400px;
      text-align: center;
    }
    
    .modal-tipo-ubicacion .btn-group {
      justify-content: center;
    }
    
    /* Modal para confirmar entrega */
    .modal-confirmar-entrega .modal-content {
      max-width: 500px;
    }
    
    .modal-confirmar-entrega .btn-group {
      margin-top: 20px;
    }
    
    /* Notificaciones */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      max-width: 350px;
    }
    
    .notification {
      background: white;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 15px;
      transform: translateX(400px);
      animation: slideIn 0.3s forwards, fadeOut 0.3s 4s forwards;
    }
    
    .notification-icon {
      font-size: 24px;
      min-width: 30px;
    }
    
    .notification-info .notification-icon {
      color: var(--primary);
    }
    
    .notification-success .notification-icon {
      color: var(--success);
    }
    
    .notification-warning .notification-icon {
      color: var(--warning);
    }
    
    .notification-error .notification-icon {
      color: var(--danger);
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .notification-message {
      font-size: 14px;
      color: #666;
    }
    
    @keyframes slideIn {
      to { transform: translateX(0); }
    }
    
    @keyframes fadeOut {
      to { opacity: 0; transform: translateX(400px); }
    }

    /* Barra de progreso */
    .progress-container {
      background: #fff;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-top: 20px;
      counter-reset: step;
    }

    .progress-bar::before {
      content: "";
      position: absolute;
      top: 15px;
      left: 0;
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      z-index: 1;
    }

    .progress {
      position: absolute;
      top: 15px;
      left: 0;
      height: 4px;
      background: #2196F3;
      z-index: 2;
      transition: width 0.3s ease;
    }

    .progress-step {
      position: relative;
      z-index: 3;
      text-align: center;
      flex: 1;
    }

    .progress-step::before {
      counter-increment: step;
      content: counter(step);
      width: 30px;
      height: 30px;
      background: #e0e0e0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
    }

    .progress-step.completed::before {
      background: #4CAF50;
      color: white;
      content: "✓";
    }

    .progress-step.active::before {
      background: #2196F3;
      color: white;
    }

    .progress-title {
      font-size: 14px;
      font-weight: 500;
    }

    /* Marcadores personalizados */
    .marker-icon {
      background: #2196F3;
      border: 2px solid white;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .delivery-icon {
      background: #4CAF50;
    }
    
    .driver-icon {
      background: #FF9800;
    }
    
    .store-icon {
      background: #2196F3;
    }
    
    /* Nuevos estilos para indicador de modo */
    .modo-ubicacion {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
      background: white;
      padding: 10px 15px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }
    
    .modo-automatico {
      background: #4caf50;
      color: white;
    }
    
    .modo-manual {
      background: #ff9800;
      color: white;
    }
    
    .modo-icono {
      font-size: 18px;
    }
    
    /* Nuevos estilos para flujo de trabajo */
    #panel-pedidos-disponibles {
      display: block;
    }
    
    #panel-seguimiento {
      display: none;
      margin-top: 20px;
    }
    
    .btn-action {
      display: none;
      margin-top: 15px;
    }

    /* Nuevo estilo para modales de proximidad */
    .modal-proximidad {
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
    }
    
    .modal-proximidad .modal-content {
      max-width: 500px;
      text-align: center;
      padding: 30px;
    }
    
    .modal-proximidad h2 {
      color: var(--primary);
      margin-bottom: 20px;
    }
    
    .modal-proximidad p {
      font-size: 1.1rem;
      margin-bottom: 25px;
    }
    
    .modal-proximidad .btn-group {
      justify-content: center;
      gap: 15px;
    }
    
    /* NUEVOS ESTILOS PARA PANEL DE LOGS */
    .panel-logs {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 300px;
      background: #1e1e1e;
      color: #d4d4d4;
      z-index: 3000;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .panel-logs.abierto {
      transform: translateY(0);
    }
    
    .logs-header {
      padding: 10px 15px;
      background: #252526;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #3c3c3c;
    }
    
    .logs-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #d4d4d4;
    }
    
    .logs-header button {
      background: #3a3d41;
      color: #d4d4d4;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }
    
    .logs-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .log-entry {
      margin-bottom: 5px;
      padding: 3px 5px;
      border-radius: 3px;
    }
    
    .log-entry:nth-child(even) {
      background: #2d2d2d;
    }
    
    .log-info {
      color: #9cdcfe;
    }
    
    .log-warning {
      color: #d7ba7d;
    }
    
    .log-success {
      color: #4ec9b0;
    }
    
    .log-error {
      color: #f48771;
    }
    
    .log-critical {
      color: #ff6161;
      font-weight: bold;
    }
    
    .btn-logs {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #252526;
      color: #d4d4d4;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    
    /* Formulario de login */
    .login-container {
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      max-width: 500px;
      margin: 50px auto;
    }
    
    .login-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
      margin-bottom: 10px;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .login-links {
      margin-top: 20px;
      text-align: center;
    }
    
    .login-links a {
      color: var(--primary);
      text-decoration: none;
      display: block;
      margin-bottom: 10px;
    }
    
    .login-links a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="notification-container" id="notification-container"></div>
  
  <!-- Indicador de modo de ubicación -->
  <div id="modo-ubicacion" class="modo-ubicacion modo-automatico" style="display: none;">
    <i class="fas fa-satellite modo-icono"></i>
    <span>Modo Automático</span>
  </div>
  
  <header>
    <div class="contenedor">
      <h1>A TU PUERTA</h1>
      <p>Panel de Mensajeros</p>
    </div>
  </header>

  <div class="contenedor">
    <div id="login-container" class="login-container">
      <h2>Iniciar sesión</h2>
      <div class="form-group">
        <label for="correo">Correo Electrónico</label>
        <input type="email" id="correo" placeholder="Tu correo">
      </div>
      <div class="form-group">
        <label for="contrasena">Contraseña</label>
        <input type="password" id="contrasena" placeholder="Tu contraseña">
      </div>
      <button id="btn-login" class="btn">Iniciar sesión</button>
      <div id="login-error" style="color: red; margin-top: 15px; display: none;"></div>
      <div class="login-links">
        <a href="registro.html?rol=mensajero">Registrarse como mensajero</a>
      </div>
    </div>

    <div id="panel-mensajero" style="display: none;">
      <div id="panel-pedidos-disponibles">
        <h2>Pedidos disponibles</h2>
        <div id="map" style="height: 500px; border-radius: 15px; margin-bottom: 25px; box-shadow: var(--sombra);"></div>
      </div>
      
      <div id="panel-seguimiento">
        <h2>Seguimiento de pedido: <span id="pedido-id"></span></h2>
        <div id="map-seguimiento" style="height: 500px; border-radius: 15px; margin-bottom: 25px; box-shadow: var(--sombra);"></div>
        
        <!-- Barra de progreso horizontal -->
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress" id="progress"></div>
            <div class="progress-step" id="step-disponible">
              <div class="progress-title">Disponible</div>
            </div>
            <div class="progress-step" id="step-proceso">
              <div class="progress-title">En proceso</div>
            </div>
            <div class="progress-step" id="step-camino">
              <div class="progress-title">En camino</div>
            </div>
            <div class="progress-step" id="step-entregado">
              <div class="progress-title">Entregado</div>
            </div>
          </div>
        </div>
        
        <div class="pedido-info-card">
          <p><strong>Estado:</strong> <span id="estado-pedido">En proceso</span></p>
          
          <!-- Botones de acción -->
          <button id="btn-iniciar-entrega" class="btn btn-action" style="display: none;">Iniciar Entrega</button>
          <button id="btn-finalizar-entrega" class="btn btn-action" style="display: none;">Finalizar Entrega</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón flotante para ubicación manual -->
  <div id="btn-ubicacion-manual" class="btn-flotante" style="display: none;">
    <i class="fas fa-map-marker-alt"></i>
  </div>

  <!-- Modal de detalles del pedido -->
  <div id="modal-detalles" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-detalles').style.display = 'none'">&times;</span>
      <h2>Detalles del Pedido</h2>
      <div id="detalles-pedido"></div>
      <button onclick="aceptarPedido()" class="btn">Aceptar Pedido</button>
    </div>
  </div>

  <!-- Modal para tipo de ubicación -->
  <div id="modal-tipo-ubicacion" class="modal modal-tipo-ubicacion">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-tipo-ubicacion').style.display = 'none'">&times;</span>
      <h2>Cambiar tipo de ubicación</h2>
      <p id="modal-tipo-ubicacion-texto"></p>
      <div class="btn-group">
        <button id="btn-cambiar-tipo-ubicacion" class="btn">Cambiar</button>
        <button onclick="document.getElementById('modal-tipo-ubicacion').style.display = 'none'" class="btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal para confirmar inicio de entrega -->
  <div id="modal-iniciar-entrega" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-iniciar-entrega').style.display = 'none'">&times;</span>
      <h2>Confirmar inicio de entrega</h2>
      <p>¿Estás en el punto de venta y has recogido el pedido?</p>
      <button onclick="confirmarInicioEntrega()" class="btn">Sí, iniciar entrega</button>
    </div>
  </div>

  <!-- Modal para confirmar finalización de entrega -->
  <div id="modal-finalizar-entrega" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-finalizar-entrega').style.display = 'none'">&times;</span>
      <h2>Confirmar entrega</h2>
      <p>¿Estás en la ubicación de entrega y has entregado el pedido?</p>
      <button onclick="confirmarFinalizarEntrega()" class="btn">Sí, finalizar entrega</button>
    </div>
  </div>

  <!-- Modal para confirmar entrega definitiva -->
  <div id="modal-confirmar-entrega" class="modal modal-confirmar-entrega">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-confirmar-entrega').style.display = 'none'">&times;</span>
      <h2>Confirmar Entrega</h2>
      <p>¿Está seguro de que concluyó la entrega? De ser así asume la responsabilidad de los pagos.</p>
      <p><strong>Advertencia:</strong> Al confirmar, el pedido se marcará como entregado y se guardará en el historial.</p>
      <div class="btn-group">
        <button id="btn-confirmar-entrega" class="btn">Confirmar Entrega</button>
        <button onclick="document.getElementById('modal-confirmar-entrega').style.display = 'none'" class="btn btn-secondary">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODALES PARA CAMBIO DE ESTADO POR PROXIMIDAD -->
  <!-- Modal para inicio de entrega por proximidad -->
  <div id="modal-iniciar-proximidad" class="modal modal-proximidad">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-iniciar-proximidad').style.display = 'none'">&times;</span>
      <h2>¡Has llegado al punto de venta!</h2>
      <p>Estás a menos de 30 metros del punto de recogida.</p>
      <p>¿Deseas cambiar el estado del pedido a "En camino"?</p>
      <div class="btn-group">
        <button onclick="confirmarInicioEntrega()" class="btn">Sí, iniciar entrega</button>
        <button onclick="document.getElementById('modal-iniciar-proximidad').style.display = 'none'" class="btn btn-secondary">Ahora no</button>
      </div>
    </div>
  </div>

  <!-- Modal para finalizar entrega por proximidad -->
  <div id="modal-finalizar-proximidad" class="modal modal-proximidad">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-finalizar-proximidad').style.display = 'none'">&times;</span>
      <h2>¡Has llegado al punto de entrega!</h2>
      <p>Estás a menos de 40 metros del destino.</p>
      <p>¿Deseas cambiar el estado del pedido a "Entregado"?</p>
      <div class="btn-group">
        <button onclick="confirmarFinalizarEntrega()" class="btn">Sí, finalizar entrega</button>
        <button onclick="document.getElementById('modal-finalizar-proximidad').style.display = 'none'" class="btn btn-secondary">Ahora no</button>
      </div>
    </div>
  </div>
  
  <!-- Botón para abrir panel de logs -->
  <div id="btn-logs" class="btn-logs">
    <i class="fas fa-bug"></i>
  </div>
  
  <!-- Panel de logs para monitoreo -->
  <div id="panel-logs" class="panel-logs">
    <div class="logs-header">
      <h3>Logs de Proximidad</h3>
      <button id="btn-cerrar-logs"><i class="fas fa-times"></i> Cerrar</button>
    </div>
    <div id="logs-content" class="logs-content"></div>
  </div>

  <footer>
    <div class="contenedor">
      <p>© 2025 A TU PUERTA - Todos los derechos reservados</p>
    </div>
  </footer>

  <script>
    // Configuración
    const config = {
      backendUrl: "https://backend-service-6ang.onrender.com/api",
      socketServer: "https://websocket-service-i32d.onrender.com",
      puntoVenta: { lat: 22.401355, lng: -79.970718 }
    };

    // Variables globales
    let map = null;
    let mapSeguimiento = null;
    let pedidoActivo = null;
    let pedidoSeleccionado = null;
    let socket = null;
    let mensajeroMarker = null;
    let trackingInterval = null;
    let telefonoMensajero = null;
    let markers = [];
    let rutaLayer = null;
    let rutaPuntoVentaLayer = null;
    let modoUbicacionManual = false;
    let marcadorManual = null;
    let verificacionInterval = null;
    
    // Variables para controlar la visualización de modales
    let mostradoModalVenta = false;
    let mostradoModalEntrega = false;

    // Elementos del DOM
    const btnIniciarEntrega = document.getElementById('btn-iniciar-entrega');
    const btnFinalizarEntrega = document.getElementById('btn-finalizar-entrega');
    const btnUbicacionManual = document.getElementById('btn-ubicacion-manual');
    const btnConfirmarEntrega = document.getElementById('btn-confirmar-entrega');
    const modoUbicacionElement = document.getElementById('modo-ubicacion');
    const btnLogin = document.getElementById('btn-login');
    
    // Variables para logs
    const logsPanel = document.getElementById('panel-logs');
    const logsContent = document.getElementById('logs-content');

    // Función para agregar logs
    function addLog(message) {
      console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
    }
    
    // Función para agregar logs al panel
    function agregarLog(mensaje, tipo = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${tipo}`;
      logEntry.innerHTML = `[${timestamp}] ${mensaje}`;
      logsContent.appendChild(logEntry);
      
      // Auto-scroll al final
      logsContent.scrollTop = logsContent.scrollHeight;
    }

    // Función mejorada para manejar errores de fetch
    async function handleFetchResponse(response) {
      if (!response.ok) {
        let errorMsg = `Error ${response.status}`;
        try {
          const errorData = await response.json();
          errorMsg = errorData.error || errorMsg;
        } catch {
          try {
            errorMsg = await response.text();
          } catch {}
        }
        throw new Error(errorMsg);
      }
      return response.json();
    }

    // Función para mostrar notificaciones
    function showNotification(title, message, type = 'info') {
      const container = document.getElementById('notification-container');
      if (!container) return;
      
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      
      let icon = 'fa-info-circle';
      if (type === 'success') icon = 'fa-check-circle';
      if (type === 'warning') icon = 'fa-exclamation-triangle';
      if (type === 'error') icon = 'fa-exclamation-circle';
      
      notification.innerHTML = `
        <div class="notification-icon">
          <i class="fas ${icon}"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
      `;
      
      container.appendChild(notification);
      
      // Eliminar notificación después de animación
      setTimeout(() => {
        notification.remove();
      }, 4500);
    }

    // Inicializar mapa principal
    function initMap() {
      if (map) map.remove();
      map = L.map('map').setView([config.puntoVenta.lat, config.puntoVenta.lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Marcador de punto de venta
      L.marker([config.puntoVenta.lat, config.puntoVenta.lng], {
        icon: L.divIcon({
          className: 'marker-icon store-icon',
          html: '<i class="fas fa-store"></i>',
          iconSize: [36, 36],
          iconAnchor: [18, 36]
        })
      }).addTo(map).bindPopup('Punto de venta');
    }

    // Inicializar mapa de seguimiento
    async function initSeguimientoMap() {
      if (!pedidoActivo) return;
      
      if (mapSeguimiento) mapSeguimiento.remove();
      mapSeguimiento = L.map('map-seguimiento').setView([
        config.puntoVenta.lat, 
        config.puntoVenta.lng
      ], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapSeguimiento);
      
      // Marcador de punto de venta
      L.marker([
        config.puntoVenta.lat,
        config.puntoVenta.lng
      ], {
        icon: L.divIcon({
          className: 'marker-icon store-icon',
          html: '<i class="fas fa-store"></i>',
          iconSize: [36, 36],
          iconAnchor: [18, 36]
        })
      }).addTo(mapSeguimiento).bindPopup('Punto de venta');

      // Marcador de destino
      L.marker([
        pedidoActivo.ubicacionEntrega.lat,
        pedidoActivo.ubicacionEntrega.lng
      ], {
        icon: L.divIcon({
          className: 'marker-icon delivery-icon',
          html: '<i class="fas fa-home"></i>',
          iconSize: [36, 36],
          iconAnchor: [18, 36]
        })
      }).addTo(mapSeguimiento).bindPopup('Destino de entrega');
    }

    // Actualizar mapa de seguimiento y verificar proximidades
    function actualizarMapaSeguimiento(lat, lng) {
      if (!mapSeguimiento) return;
      
      if (modoUbicacionManual && marcadorManual) {
        // Modo manual: actualizar marcador existente
        marcadorManual.setLatLng([lat, lng]);
      } else {
        // Modo automático: crear o actualizar marcador
        if (mensajeroMarker) {
          mensajeroMarker.setLatLng([lat, lng]);
        } else {
          mensajeroMarker = L.marker([lat, lng], {
            icon: L.divIcon({
              className: 'marker-icon driver-icon',
              html: '<i class="fas fa-motorcycle"></i>',
              iconSize: [36, 36],
              iconAnchor: [18, 36]
            })
          }).addTo(mapSeguimiento).bindPopup('Mensajero');
          
          // Evento para cambiar tipo de ubicación al hacer clic en el marcador
          mensajeroMarker.on('click', function() {
            mostrarModalTipoUbicacion();
          });
        }
      }
      
      mapSeguimiento.setView([lat, lng], 15);
      
      // Verificar proximidades siempre que se actualice la ubicación
      verificarProximidades(lat, lng);
    }

    // Función para calcular distancia en metros usando fórmula de Haversine
    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Radio de la Tierra en metros
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    // Verificar proximidades a puntos clave (funciona en ambos modos)
    function verificarProximidades(lat, lng) {
      if (!pedidoActivo) return;
      
      // Calcular distancias con precisión
      const distanciaVenta = calcularDistancia(
        lat, lng, 
        config.puntoVenta.lat, config.puntoVenta.lng
      );
      
      const distanciaEntrega = calcularDistancia(
        lat, lng, 
        pedidoActivo.ubicacionEntrega.lat, pedidoActivo.ubicacionEntrega.lng
      );
      
      // Log de información básica
      agregarLog(`Ubicación actual: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'info');
      agregarLog(`Distancia a punto de venta: ${distanciaVenta.toFixed(2)} metros`, 'info');
      agregarLog(`Distancia a punto de entrega: ${distanciaEntrega.toFixed(2)} metros`, 'info');
      agregarLog(`Estado actual: ${pedidoActivo.estado}`, 'info');
      
      // Log de proximidad al punto de venta
      if (distanciaVenta <= 30) {
        agregarLog(`¡A menos de 30m del punto de venta!`, 'success');
      } else {
        agregarLog(`Aún no está en rango de punto de venta (${distanciaVenta.toFixed(2)}m)`, 'warning');
      }
      
      // Log de proximidad al punto de entrega
      if (distanciaEntrega <= 40) {
        agregarLog(`¡A menos de 40m del punto de entrega!`, 'success');
      } else {
        agregarLog(`Aún no está en rango de entrega (${distanciaEntrega.toFixed(2)}m)`, 'warning');
      }
      
      // MOSTRAR MODALES POR PROXIMIDAD
      // Modal para inicio de entrega cuando está cerca del punto de venta
      if (distanciaVenta <= 30 && !mostradoModalVenta && pedidoActivo.estado === 'en proceso') {
        agregarLog('Mostrando modal para iniciar entrega', 'critical');
        document.getElementById('modal-iniciar-proximidad').style.display = 'block';
        mostradoModalVenta = true;
      }
      
      // Modal para finalizar entrega cuando está cerca del punto de entrega
      if (distanciaEntrega <= 40 && !mostradoModalEntrega && pedidoActivo.estado === 'en camino') {
        agregarLog('Mostrando modal para finalizar entrega', 'critical');
        document.getElementById('modal-finalizar-proximidad').style.display = 'block';
        mostradoModalEntrega = true;
      }
      
      agregarLog('------------------------------------------------', 'info');
    }

    // Obtener pedidos disponibles
    async function obtenerPedidosDisponibles() {
      try {
        const response = await fetch(`${config.backendUrl}/pedidos/disponibles`);
        return await handleFetchResponse(response);
      } catch (error) {
        addLog(`Error obteniendo pedidos: ${error.message}`);
        return [];
      }
    }

    // Mostrar pedidos disponibles en el mapa
    async function mostrarPedidosDisponibles() {
      try {
        const pedidos = await obtenerPedidosDisponibles();
        
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        
        if (pedidos.length === 0) {
          addLog('No hay pedidos disponibles');
          return;
        }
        
        // Crear un grupo para ajustar el mapa
        const markerGroup = [];
        
        pedidos.forEach(pedido => {
          const marker = L.marker([
            pedido.ubicacionEntrega.lat,
            pedido.ubicacionEntrega.lng
          ], {
            icon: L.divIcon({
              className: 'marker-icon delivery-icon',
              html: '<i class="fas fa-home"></i>',
              iconSize: [30, 30],
              iconAnchor: [15, 30]
            })
          }).addTo(map).bindPopup(`Pedido #${pedido.id.slice(-6)}`);
          
          // Al hacer clic en el marcador, mostrar el modal
          marker.on('click', () => {
            mostrarDetallesPedido(pedido);
          });
          
          markers.push(marker);
          markerGroup.push(marker.getLatLng());
        });
        
        // Ajustar el mapa para que muestre todos los marcadores
        if (markerGroup.length > 0) {
          const group = new L.featureGroup(markers);
          map.fitBounds(group.getBounds().pad(0.2));
        }
        
        addLog(`Mostrando ${pedidos.length} pedidos disponibles`);
        
        // Programar próxima actualización en 5 segundos
        setTimeout(mostrarPedidosDisponibles, 5000);
        
      } catch (error) {
        addLog(`Error: ${error.message}`);
        // Reintentar en 10 segundos si hay error
        setTimeout(mostrarPedidosDisponibles, 10000);
      }
    }

    // Función para mostrar detalles del pedido en modal
    function mostrarDetallesPedido(pedido) {
      const modal = document.getElementById('modal-detalles');
      const detalles = document.getElementById('detalles-pedido');
      
      // Crear lista de productos
      const productosHTML = pedido.productos.map(p => 
        `<li>${p.nombre} x ${p.cantidad} - ${p.precio * p.cantidad} CUP</li>`
      ).join('');
      
      detalles.innerHTML = `
        <h3>Pedido #${pedido.id.slice(-6)}</h3>
        <p><strong>Ubicación entrega:</strong> ${pedido.ubicacionEntrega.lat.toFixed(6)}, ${pedido.ubicacionEntrega.lng.toFixed(6)}</p>
        <p><strong>Distancia:</strong> ${pedido.distanciaCarreteraKm || '?'} km</p>
        <p><strong>Costo mensajería:</strong> ${pedido.precioDelivery || 'Negociar'} CUP</p>
        <h4>Productos:</h4>
        <ul>${productosHTML}</ul>
      `;
      
      modal.style.display = 'block';
      pedidoSeleccionado = pedido;
    }

    // Función para aceptar pedido
    async function aceptarPedido() {
      if (!pedidoSeleccionado) return;
      
      try {
        const response = await fetch(`${config.backendUrl}/pedidos/asignar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pedidoId: pedidoSeleccionado.id,
            mensajeroId: telefonoMensajero
          })
        });
        
        const data = await handleFetchResponse(response);
        
        document.getElementById('modal-detalles').style.display = 'none';
        pedidoActivo = data;  // Usar el pedido actualizado del servidor
        pedidoSeleccionado = null;
        
        // Ocultar panel de pedidos disponibles
        document.getElementById('panel-pedidos-disponibles').style.display = 'none';
        
        // Mostrar sección de seguimiento
        document.getElementById('panel-seguimiento').style.display = 'block';
        document.getElementById('pedido-id').textContent = pedidoActivo.id.slice(-6);
        
        // Inicializar mapa de seguimiento
        initSeguimientoMap();
        
        // Mostrar botón flotante para ubicación manual
        btnUbicacionManual.style.display = 'block';
        
        // Mostrar indicador de modo de ubicación
        modoUbicacionElement.style.display = 'flex';
        actualizarIndicadorModo();
        
        // Actualizar estado automáticamente
        actualizarBarraProgreso(pedidoActivo.estado);
        
        // Obtener ubicación actual para trazar ruta al punto de venta
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async position => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              
              // Dibujar ruta desde la ubicación actual al punto de venta
              await dibujarRutaAlPuntoVenta(
                { lat, lng },
                config.puntoVenta
              );
              
              // Iniciar seguimiento automático
              iniciarSeguimientoUbicacion();
            },
            error => {
              addLog(`Error obteniendo ubicación: ${error.message}`);
            }
          );
        }
        
        addLog(`Pedido #${pedidoActivo.id.slice(-6)} aceptado`);
      } catch (error) {
        addLog(`Error aceptando pedido: ${error.message}`);
        alert(`Error: ${error.message}`);
      }
    }

    // Función para actualizar la barra de progreso
    function actualizarBarraProgreso(estado) {
      const estados = ['disponible', 'en proceso', 'en camino', 'entregado'];
      const estadoIndex = estados.indexOf(estado);
      const progressPercentage = estadoIndex >= 0 ? (estadoIndex / (estados.length - 1)) * 100 : 0;
      
      document.getElementById('progress').style.width = `${progressPercentage}%`;
      document.getElementById('estado-pedido').textContent = estado;
      
      estados.forEach((est, index) => {
        const stepId = `step-${est.replace(' ', '-')}`;
        const step = document.getElementById(stepId);
        if (step) {
          step.classList.remove('completed', 'active');
          if (index < estadoIndex) {
            step.classList.add('completed');
          } else if (index === estadoIndex) {
            step.classList.add('active');
          }
        }
      });
    }

    // Función para actualizar el estado del pedido
    async function actualizarEstadoPedido(estado) {
      try {
        let endpoint = '';
        if (estado === 'en camino') {
          endpoint = `${config.backendUrl}/pedidos/en-camino`;
        } else if (estado === 'entregado') {
          endpoint = `${config.backendUrl}/pedidos/entregado`;
        } else {
          throw new Error('Estado no válido');
        }
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            pedidoId: pedidoActivo.id
          })
        });
        
        const data = await handleFetchResponse(response);
        addLog(`Estado actualizado a: ${estado}`);
        
        // Actualizar el estado en el objeto local
        pedidoActivo.estado = estado;
        
        // Actualizar barra de progreso
        actualizarBarraProgreso(estado);
        
        // Reiniciar los flags de modales
        mostradoModalVenta = false;
        mostradoModalEntrega = false;
        
        return true;
      } catch (error) {
        addLog(`Error actualizando estado: ${error.message}`);
        return false;
      }
    }

    // Iniciar seguimiento de ubicación
    function iniciarSeguimientoUbicacion() {
      if (trackingInterval) clearInterval(trackingInterval);
      
      trackingInterval = setInterval(() => {
        if (navigator.geolocation && !modoUbicacionManual) {
          navigator.geolocation.getCurrentPosition(
            position => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              
              actualizarMapaSeguimiento(lat, lng);
              verificarProximidades(lat, lng);
              
              if (socket && socket.connected) {
                socket.emit('actualizar_ubicacion', {
                  pedidoId: pedidoActivo.id,
                  lat,
                  lng
                });
                addLog(`Ubicación actualizada: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
              }
            },
            error => {
              addLog(`Error de geolocalización: ${error.message}`);
            }
          );
        }
      }, 5000);
    }

    // Función para dibujar ruta al punto de venta
    async function dibujarRutaAlPuntoVenta(origen, destino) {
      try {
        const response = await fetch(`${config.backendUrl}/ruta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            origen: origen,
            destino: destino
          })
        });
        
        const data = await response.json();
        const coords = polyline.decode(data.geometria);
        const latLngs = coords.map(coord => L.latLng(coord[0], coord[1]));
        
        if (rutaPuntoVentaLayer) {
          mapSeguimiento.removeLayer(rutaPuntoVentaLayer);
        }
        
        rutaPuntoVentaLayer = L.polyline(latLngs, {
          color: '#4caf50',
          weight: 6,
          opacity: 0.8,
          lineJoin: 'round'
        }).addTo(mapSeguimiento);
        
        const bounds = L.latLngBounds(latLngs);
        mapSeguimiento.fitBounds(bounds);
        
      } catch (error) {
        addLog(`Error dibujando ruta: ${error.message}`);
      }
    }

    // Función para dibujar ruta al cliente
    async function dibujarRutaAlCliente(origen, destino) {
      try {
        const response = await fetch(`${config.backendUrl}/ruta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            origen: origen,
            destino: destino
          })
        });
        
        const data = await response.json();
        const coords = polyline.decode(data.geometria);
        const latLngs = coords.map(coord => L.latLng(coord[0], coord[1]));
        
        if (rutaLayer) {
          mapSeguimiento.removeLayer(rutaLayer);
        }
        
        rutaLayer = L.polyline(latLngs, {
          color: '#d62828',
          weight: 6,
          opacity: 0.8,
          lineJoin: 'round'
        }).addTo(mapSeguimiento);
        
        const bounds = L.latLngBounds(latLngs);
        mapSeguimiento.fitBounds(bounds);
        
      } catch (error) {
        addLog(`Error dibujando ruta: ${error.message}`);
      }
    }

    // Función para actualizar el indicador de modo
    function actualizarIndicadorModo() {
      if (!modoUbicacionManual) {
        modoUbicacionElement.className = 'modo-ubicacion modo-automatico';
        modoUbicacionElement.innerHTML = '<i class="fas fa-satellite modo-icono"></i> <span>Modo Automático</span>';
      } else {
        modoUbicacionElement.className = 'modo-ubicacion modo-manual';
        modoUbicacionElement.innerHTML = '<i class="fas fa-map-marker-alt modo-icono"></i> <span>Modo Manual</span>';
      }
    }

    // Función para mostrar modal de tipo de ubicación
    function mostrarModalTipoUbicacion() {
      const modal = document.getElementById('modal-tipo-ubicacion');
      const texto = document.getElementById('modal-tipo-ubicacion-texto');
      const btnCambiar = document.getElementById('btn-cambiar-tipo-ubicacion');
      
      if (modoUbicacionManual) {
        texto.textContent = '¿Volver a modo automático?';
        btnCambiar.textContent = 'Automático';
        btnCambiar.onclick = function() {
          cambiarTipoUbicacion(false);
          modal.style.display = 'none';
        };
      } else {
        texto.textContent = '¿Cambiar a modo manual? En este modo, podrás establecer tu ubicación haciendo clic en el mapa.';
        btnCambiar.textContent = 'Manual';
        btnCambiar.onclick = function() {
          cambiarTipoUbicacion(true);
          modal.style.display = 'none';
        };
      }
      
      modal.style.display = 'block';
    }

    // Función para cambiar el tipo de ubicación
    function cambiarTipoUbicacion(manual) {
      modoUbicacionManual = manual;
      actualizarIndicadorModo();
      
      if (modoUbicacionManual) {
        // Detener seguimiento automático
        if (trackingInterval) {
          clearInterval(trackingInterval);
          trackingInterval = null;
        }
        
        // Crear marcador manual si no existe
        if (!marcadorManual) {
          // Obtener posición actual si está disponible
          let currentPos = config.puntoVenta;
          if (mensajeroMarker) {
            currentPos = mensajeroMarker.getLatLng();
          }
          
          marcadorManual = L.marker([currentPos.lat, currentPos.lng], {
            icon: L.divIcon({
              className: 'marker-icon driver-icon',
              html: '<i class="fas fa-motorcycle"></i>',
              iconSize: [36, 36],
              iconAnchor: [18, 36]
            }),
            draggable: true
          }).addTo(mapSeguimiento);
          
          // Evento para arrastrar marcador
          marcadorManual.on('dragend', function(event) {
            const marker = event.target;
            const position = marker.getLatLng();
            
            // Actualizar ubicación
            actualizarMapaSeguimiento(position.lat, position.lng);
            verificarProximidades(position.lat, position.lng);
            
            // Enviar al servidor
            if (socket && socket.connected) {
              socket.emit('actualizar_ubicacion', {
                pedidoId: pedidoActivo.id,
                lat: position.lat,
                lng: position.lng
              });
              addLog(`Ubicación manual actualizada: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`);
            }
          });
          
          // Evento para cambiar tipo de ubicación
          marcadorManual.on('click', function() {
            mostrarModalTipoUbicacion();
          });
        }
        
        // Eliminar marcador automático si existe
        if (mensajeroMarker) {
          mapSeguimiento.removeLayer(mensajeroMarker);
          mensajeroMarker = null;
        }
        
        // Evento para hacer clic en el mapa
        mapSeguimiento.on('click', function(e) {
          const lat = e.latlng.lat;
          const lng = e.latlng.lng;
          
          // Actualizar ubicación del marcador manual
          marcadorManual.setLatLng([lat, lng]);
          verificarProximidades(lat, lng);
          
          // Enviar al servidor
          if (socket && socket.connected) {
            socket.emit('actualizar_ubicacion', {
              pedidoId: pedidoActivo.id,
              lat,
              lng
            });
            addLog(`Ubicación manual actualizada: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
          }
        });
        
        addLog('Modo manual activado: Haz clic en el mapa para establecer tu ubicación');
      } else {
        // Eliminar marcador manual si existe
        if (marcadorManual) {
          mapSeguimiento.removeLayer(marcadorManual);
          marcadorManual = null;
        }
        
        // Eliminar evento de clic del mapa
        mapSeguimiento.off('click');
        
        // Reanudar seguimiento automático
        iniciarSeguimientoUbicacion();
        
        addLog('Modo automático activado');
      }
    }

    // Inicializar WebSocket
    function initSocket() {
      socket = io(config.socketServer, {
        transports: ['websocket'],
        reconnection: true
      });

      socket.on('connect', () => {
        addLog('Conectado al servidor de seguimiento');
      });

      socket.on('disconnect', () => {
        addLog('Desconectado del servidor');
      });

      // Escuchar actualización de estado
      socket.on('actualizacion_estado', (data) => {
        if (pedidoActivo && data.pedidoId === pedidoActivo.id) {
          pedidoActivo.estado = data.estado;
          actualizarBarraProgreso(data.estado);
        }
      });
    }

    // Event listeners para los botones
    btnIniciarEntrega.addEventListener('click', function() {
      // Mostrar modal de confirmación
      document.getElementById('modal-iniciar-entrega').style.display = 'block';
    });
    
    btnFinalizarEntrega.addEventListener('click', function() {
      // Mostrar modal de confirmación
      document.getElementById('modal-finalizar-entrega').style.display = 'block';
    });
    
    // Confirmar inicio de entrega
    async function confirmarInicioEntrega() {
      const exito = await actualizarEstadoPedido('en camino');
      if (exito) {
        btnIniciarEntrega.style.display = 'none';
        document.getElementById('modal-iniciar-entrega').style.display = 'none';
        document.getElementById('modal-iniciar-proximidad').style.display = 'none';
        
        // Dibujar ruta desde el punto de venta al cliente
        await dibujarRutaAlCliente(
          config.puntoVenta,
          pedidoActivo.ubicacionEntrega
        );
      }
    }
    
    // Confirmar finalización de entrega
    async function confirmarFinalizarEntrega() {
      document.getElementById('modal-finalizar-entrega').style.display = 'none';
      document.getElementById('modal-finalizar-proximidad').style.display = 'none';
      // Mostrar modal de confirmación definitiva
      document.getElementById('modal-confirmar-entrega').style.display = 'block';
    }
    
    // Confirmar entrega definitiva
    btnConfirmarEntrega.addEventListener('click', async function() {
      if (trackingInterval) clearInterval(trackingInterval);
      
      try {
        // Mostrar feedback de carga
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        this.disabled = true;
        
        // Actualizar estado a entregado
        await actualizarEstadoPedido('entregado');
        
        showNotification('¡Éxito!', 'Pedido guardado en historial', 'success');
        addLog(`Pedido #${pedidoActivo.id.slice(-6)} entregado`);
        
        // Cerrar modal
        document.getElementById('modal-confirmar-entrega').style.display = 'none';
        
        // Restaurar el botón después de un breve retraso
        setTimeout(() => {
          this.innerHTML = originalText;
          this.disabled = false;
          alert('¡Entrega finalizada con éxito!');
          
          document.getElementById('panel-seguimiento').style.display = 'none';
          pedidoActivo = null;
          mensajeroMarker = null;
          marcadorManual = null;
          btnUbicacionManual.style.display = 'none';
          modoUbicacionElement.style.display = 'none';
          
          // Mostrar nuevamente los pedidos disponibles
          document.getElementById('panel-pedidos-disponibles').style.display = 'block';
          mostrarPedidosDisponibles();
        }, 2000);
        
      } catch (error) {
        showNotification('Error', 'No se pudo guardar el historial', 'error');
        addLog(`Error finalizando entrega: ${error.message}`);
        
        // Restaurar el botón
        this.innerHTML = originalText;
        this.disabled = false;
        alert(`Error: ${error.message}`);
      }
    });

    // Event listener para el botón de ubicación manual
    btnUbicacionManual.addEventListener('click', function() {
      mostrarModalTipoUbicacion();
    });

    // Iniciar sesión para mensajeros
    async function iniciarSesion() {
      const correo = document.getElementById('correo').value;
      const contrasena = document.getElementById('contrasena').value;
      const errorElement = document.getElementById('login-error');
      errorElement.style.display = 'none';
      
      if (!correo || !contrasena) {
        errorElement.textContent = 'Complete todos los campos';
        errorElement.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`${config.backendUrl}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            correo, 
            contrasena,
            rol: 'mensajero'
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          localStorage.setItem('token', result.token);
          telefonoMensajero = result.telefono;
          
          document.getElementById('login-container').style.display = 'none';
          document.getElementById('panel-mensajero').style.display = 'block';
          
          initMap();
          mostrarPedidosDisponibles();
          initSocket();
          addLog(`Sesión iniciada: ${correo}`);
        } else {
          errorElement.textContent = result.error || 'Credenciales inválidas';
          errorElement.style.display = 'block';
        }
      } catch (error) {
        console.error('Error:', error);
        errorElement.textContent = 'Error de conexión';
        errorElement.style.display = 'block';
      }
    }

    // Event listeners para panel de logs
    document.getElementById('btn-logs').addEventListener('click', () => {
      logsPanel.classList.add('abierto');
    });
    
    document.getElementById('btn-cerrar-logs').addEventListener('click', () => {
      logsPanel.classList.remove('abierto');
    });

    // Inicializar
    window.onload = function() {
      // Configurar evento de login
      btnLogin.addEventListener('click', iniciarSesion);
      
      // Inicializar WebSocket
      initSocket();
      addLog('Sistema iniciado');
    };
  </script>
</body>
</html>